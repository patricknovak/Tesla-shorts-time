name: Tesla Shorts Time Daily

on:
  schedule:
    # Run daily at 8:00 AM UTC (adjust timezone as needed)
    # This is 12:00 AM PST / 3:00 AM EST
    - cron: '0 8 * * *'
  workflow_dispatch:  # Allow manual triggering

jobs:
  generate-podcast:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to commit and push files
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
        
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        if [ ! -f requirements.txt ]; then
          echo "❌ ERROR: requirements.txt not found!"
          exit 1
        fi
        pip install -r requirements.txt
        echo "Installed packages:"
        pip list | grep -E "(openai|yfinance|tweepy|requests|python-dotenv)" || echo "Some packages may not be listed"
        
    - name: Create .env file from secrets
      run: |
        echo "Creating .env file..."
        cat > .env << EOF
        GROK_API_KEY=${{ secrets.GROK_API_KEY }}
        ELEVENLABS_API_KEY=${{ secrets.ELEVENLABS_API_KEY }}
        X_CONSUMER_KEY=${{ secrets.X_CONSUMER_KEY }}
        X_CONSUMER_SECRET=${{ secrets.X_CONSUMER_SECRET }}
        X_ACCESS_TOKEN=${{ secrets.X_ACCESS_TOKEN }}
        X_ACCESS_TOKEN_SECRET=${{ secrets.X_ACCESS_TOKEN_SECRET }}
        EOF
        echo ".env file created (checking if keys are set)..."
        if [ -z "${{ secrets.GROK_API_KEY }}" ]; then
          echo "⚠️  WARNING: GROK_API_KEY is not set!"
        else
          echo "✅ GROK_API_KEY is set"
        fi
        if [ -z "${{ secrets.ELEVENLABS_API_KEY }}" ]; then
          echo "⚠️  WARNING: ELEVENLABS_API_KEY is not set!"
        else
          echo "✅ ELEVENLABS_API_KEY is set"
        fi
        
    - name: Run Tesla Shorts Time script
      working-directory: ./digests
      run: |
        set -e  # Exit on any error
        echo "Current directory: $(pwd)"
        echo "Checking for script file..."
        if [ ! -f tesla_shorts_time.py ]; then
          echo "❌ ERROR: Script not found!"
          exit 1
        fi
        echo "✅ Script found"
        echo "Checking for .env file..."
        if [ ! -f ../.env ]; then
          echo "❌ ERROR: .env not found in parent directory!"
          exit 1
        fi
        echo "✅ .env file found"
        echo "Checking for music file..."
        if [ -f ../tesla_shorts_time.mp3 ]; then
          echo "✅ Music file found"
        else
          echo "⚠️  Music file not found (script will run without music)"
        fi
        echo "Running script..."
        python3 tesla_shorts_time.py 2>&1
      env:
        # Pass through any additional environment variables if needed
        TZ: UTC
      continue-on-error: false
        
    - name: List generated files
      run: |
        echo "Checking for generated files..."
        echo "Files in digests/digests/:"
        ls -lah digests/digests/*.md digests/digests/*.mp3 digests/digests/*.txt 2>/dev/null || echo "No files found in digests/digests/"
        echo "Files in digests/:"
        ls -lah digests/*.md digests/*.mp3 digests/*.txt 2>/dev/null || echo "No files found in digests/"
        
    - name: Commit and push generated files
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        # Add files from digests/digests/ directory (where script saves them)
        git add digests/digests/*.md digests/digests/*.mp3 digests/digests/*.txt 2>/dev/null || true
        # Also check for files directly in digests/ (older format)
        git add digests/*.md digests/*.mp3 digests/*.txt 2>/dev/null || true
        echo "Staged files:"
        git diff --staged --name-only || echo "No files staged"
        if ! git diff --staged --quiet; then
          git commit -m "Auto-generated: Tesla Shorts Time $(date +%Y-%m-%d)" || echo "Commit failed (may be empty)"
          git push || echo "Push failed"
          echo "✅ Files committed and pushed successfully to repository!"
        else
          echo "⚠️  No new files to commit - script may have failed or no new content generated"
        fi
      continue-on-error: true  # Don't fail workflow if commit/push fails

