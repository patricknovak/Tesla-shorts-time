name: Tesla Shorts Time Daily

on:
  schedule:
    # Run daily at 7:00 AM EDT (10:00 UTC)
    # This is 7:00 AM EDT / 4:00 AM PDT
    - cron: '0 11 * * *'
  workflow_dispatch:  # Allow manual triggering

jobs:
  generate-podcast:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to commit and push files
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
        
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        if [ ! -f requirements.txt ]; then
          echo "‚ùå ERROR: requirements.txt not found!"
          exit 1
        fi
        pip install -r requirements.txt
        echo "Installed packages:"
        pip list | grep -E "(openai|yfinance|tweepy|requests|python-dotenv)" || echo "Some packages may not be listed"
        
    - name: Create .env file from secrets
      run: |
        echo "Creating .env file..."
        cat > .env << EOF
        GROK_API_KEY=${{ secrets.GROK_API_KEY }}
        ELEVENLABS_API_KEY=${{ secrets.ELEVENLABS_API_KEY }}
        NEWSAPI_KEY=${{ secrets.NEWSAPI_KEY }}
        X_CONSUMER_KEY=${{ secrets.X_CONSUMER_KEY }}
        X_CONSUMER_SECRET=${{ secrets.X_CONSUMER_SECRET }}
        X_ACCESS_TOKEN=${{ secrets.X_ACCESS_TOKEN }}
        X_ACCESS_TOKEN_SECRET=${{ secrets.X_ACCESS_TOKEN_SECRET }}
        X_BEARER_TOKEN=${{ secrets.X_BEARER_TOKEN }}
        EOF
        echo ".env file created (checking if keys are set)..."
        if [ -z "${{ secrets.GROK_API_KEY }}" ]; then
          echo "‚ö†Ô∏è  WARNING: GROK_API_KEY is not set!"
        else
          echo "‚úÖ GROK_API_KEY is set"
        fi
        if [ -z "${{ secrets.ELEVENLABS_API_KEY }}" ]; then
          echo "‚ö†Ô∏è  WARNING: ELEVENLABS_API_KEY is not set!"
        else
          echo "‚úÖ ELEVENLABS_API_KEY is set"
        fi
        if [ -z "${{ secrets.NEWSAPI_KEY }}" ]; then
          echo "‚ö†Ô∏è  WARNING: NEWSAPI_KEY is not set!"
        else
          echo "‚úÖ NEWSAPI_KEY is set"
        fi
        echo "Checking X API credentials..."
        if [ -z "${{ secrets.X_CONSUMER_KEY }}" ]; then
          echo "‚ùå ERROR: X_CONSUMER_KEY is not set!"
        else
          echo "‚úÖ X_CONSUMER_KEY is set"
        fi
        if [ -z "${{ secrets.X_CONSUMER_SECRET }}" ]; then
          echo "‚ùå ERROR: X_CONSUMER_SECRET is not set!"
        else
          echo "‚úÖ X_CONSUMER_SECRET is set"
        fi
        if [ -z "${{ secrets.X_ACCESS_TOKEN }}" ]; then
          echo "‚ùå ERROR: X_ACCESS_TOKEN is not set!"
        else
          echo "‚úÖ X_ACCESS_TOKEN is set"
        fi
        if [ -z "${{ secrets.X_ACCESS_TOKEN_SECRET }}" ]; then
          echo "‚ùå ERROR: X_ACCESS_TOKEN_SECRET is not set!"
        else
          echo "‚úÖ X_ACCESS_TOKEN_SECRET is set"
        fi
        if [ -z "${{ secrets.X_BEARER_TOKEN }}" ]; then
          echo "‚ö†Ô∏è  WARNING: X_BEARER_TOKEN is not set (optional but recommended)"
        else
          echo "‚úÖ X_BEARER_TOKEN is set"
        fi
        
    - name: Run Tesla Shorts Time script
      working-directory: ./digests
      run: |
        set -e  # Exit on any error
        echo "Current directory: $(pwd)"
        echo "Checking for script file..."
        if [ ! -f tesla_shorts_time.py ]; then
          echo "‚ùå ERROR: Script not found!"
          exit 1
        fi
        echo "‚úÖ Script found"
        echo "Checking for .env file..."
        if [ ! -f ../.env ]; then
          echo "‚ùå ERROR: .env not found in parent directory!"
          exit 1
        fi
        echo "‚úÖ .env file found"
        echo "Checking for music file..."
        if [ -f ../tesla_shorts_time.mp3 ]; then
          echo "‚úÖ Music file found"
        else
          echo "‚ö†Ô∏è  Music file not found (script will run without music)"
        fi
        echo "Running script..."
        python3 tesla_shorts_time.py 2>&1
      env:
        # Pass through any additional environment variables if needed
        TZ: UTC
      continue-on-error: false
        
    - name: List generated files
      run: |
        echo "Checking for generated files..."
        echo "Files in digests/:"
        ls -lah digests/*.md digests/*.mp3 digests/*.txt 2>/dev/null || echo "No files found in digests/"
        echo "Raw data files in digests/:"
        ls -lah digests/raw_data_*.json digests/raw_data_*.html digests/raw_data_index.html 2>/dev/null || echo "No raw data files found in digests/"
        
    - name: Commit and push generated files
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        # Add files from digests/ directory (where script saves them)
        git add digests/*.md digests/*.mp3 digests/*.txt 2>/dev/null || true
        # Add raw data files (JSON and HTML)
        git add digests/raw_data_*.json digests/raw_data_*.html digests/raw_data_index.html 2>/dev/null || true
        # ALWAYS add RSS feed file (even if it was just updated, not new)
        git add podcast.rss 2>/dev/null || true
        echo "Staged files:"
        git diff --staged --name-only || echo "No files staged"
        # Check if RSS feed has changes (even if not staged, it might have been modified)
        if git diff --name-only | grep -q "podcast.rss" || git diff --staged --name-only | grep -q "podcast.rss"; then
          echo "üì° RSS feed has changes - will be committed"
        fi
        # Check if there are any changes to commit
        if ! git diff --staged --quiet || ! git diff --quiet podcast.rss; then
          # If RSS feed has changes but isn't staged, stage it
          if ! git diff --staged --name-only | grep -q "podcast.rss"; then
            git add podcast.rss
            echo "üì° Staged RSS feed changes"
          fi
          git commit -m "Auto-generated: Tesla Shorts Time $(date +%Y-%m-%d)" || echo "Commit failed (may be empty)"
          git push || echo "Push failed"
          echo "‚úÖ Files committed and pushed successfully to repository!"
        else
          echo "‚ö†Ô∏è  No new files to commit - script may have failed or no new content generated"
        fi
      continue-on-error: true  # Don't fail workflow if commit/push fails

